<%- include('partials/header') %>

<section class="min-h-screen bg-black text-white pt-32 pb-20 px-4 relative overflow-hidden">
    
    <!-- Decorative Background Element -->
    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-full pointer-events-none opacity-20">
        <div class="w-full h-[500px] bg-gradient-to-b from-[#D4AF37] to-transparent rounded-full blur-[120px]"></div>
    </div>

    <div class="max-w-6xl mx-auto relative z-10">
        
        <!-- Header -->
        <div class="text-center mb-16">
            <h1 class="text-5xl md:text-7xl font-black text-[#D4AF37] mb-6 brand-font tracking-tighter uppercase text-gold">The Platform</h1>
            <p class="text-xl text-gray-400 max-w-2xl mx-auto leading-relaxed">
                Directives for a sovereign future. We advocate for the structural evolution of the human experience through logic, machine context, and biological integrity.
            </p>
        </div>

        <!-- Agenda Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-fr mb-20">

            <!-- 1. Modernizing Justice -->
            <div class="glass-card p-8 rounded-2xl border-l-4 border-[#D4AF37] hover:bg-white/5 transition-all duration-500 lg:col-span-2 flex flex-col justify-center">
                <div class="flex flex-col md:flex-row gap-6 items-start md:items-center">
                    <div class="bg-[#D4AF37]/10 p-5 rounded-full text-[#D4AF37] flex-shrink-0">
                        <i class="fas fa-balance-scale-right text-4xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-3 brand-font">Modernizing Justice</h2>
                        <p class="text-gray-300 leading-relaxed">
                            Moving beyond retributive antiquity. We advocate for a justice system built on data-driven restoration and objective truth.
                        </p>
                    </div>
                </div>
            </div>

            <!-- 2. Biological Fidelity -->
            <div class="glass-card p-8 rounded-2xl border-l-4 border-[#20B2AA] hover:bg-white/5 transition-all duration-500 flex flex-col items-center text-center justify-center">
                <div class="bg-[#20B2AA]/10 p-4 rounded-full text-[#20B2AA] mb-4">
                    <i class="fas fa-dna text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-2 brand-font">Biological Fidelity</h2>
                <p class="text-gray-400 text-sm leading-relaxed">
                    Eliminating substance poisoning to ensure a clear signal. Removing systemic toxins to keep the vessel as pure as the intent.
                </p>
            </div>

            <!-- 3. Machine Context -->
            <div class="glass-card p-8 rounded-2xl border-l-4 border-[#F4C430] hover:bg-white/5 transition-all duration-500 flex flex-col items-center text-center justify-center">
                <div class="bg-[#F4C430]/10 p-4 rounded-full text-[#F4C430] mb-4">
                    <i class="fas fa-microchip text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-2 brand-font">Machine Context</h2>
                <p class="text-gray-400 text-sm leading-relaxed">
                    Leveraging AI as a neutral arbiter in human friction, providing context to noise and intervention to irrationality.
                </p>
            </div>

            <!-- 4. Neural Maximization -->
            <div class="glass-card p-8 rounded-2xl border-l-4 border-[#FF4500] hover:bg-white/5 transition-all duration-500 lg:row-span-2 flex flex-col justify-center">
                <div class="bg-[#FF4500]/10 p-5 w-fit rounded-full text-[#FF4500] mb-6">
                    <i class="fas fa-brain text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-4 brand-font">Neural Maximization</h2>
                <p class="text-gray-300 leading-relaxed">
                    Every human brain deserves its highest potential. We advocate for infrastructure that optimizes cognitive health and neural plasticity.
                </p>
                <div class="mt-6 pt-6 border-t border-white/10 text-xs text-gray-500 uppercase tracking-widest">
                    Optimization Priority: High
                </div>
            </div>

            <!-- 5. Post-Addiction Economics -->
            <div class="glass-card p-8 rounded-2xl border-l-4 border-[#9370DB] hover:bg-white/5 transition-all duration-500 flex flex-col items-center text-center justify-center">
                <div class="bg-[#9370DB]/10 p-4 rounded-full text-[#9370DB] mb-4">
                    <i class="fas fa-hand-holding-heart text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-2 brand-font">Post-Addiction Economics</h2>
                <p class="text-gray-400 text-sm leading-relaxed">
                    Ending the exploitation of the dopamine loop. Pivoting to a value-based economy that rewards growth over dependency.
                </p>
            </div>

            <!-- 6. Dialogue Towards Utopia -->
            <div class="glass-card p-8 rounded-2xl border-l-4 border-[#FFD700] hover:bg-white/5 transition-all duration-500 lg:col-span-2 flex flex-col justify-center">
                <div class="flex flex-col md:flex-row gap-6 items-start">
                    <div class="bg-[#FFD700]/10 p-5 rounded-full text-[#FFD700] flex-shrink-0">
                        <i class="fas fa-comments text-3xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2 brand-font">Constructive Utopianism</h2>
                        <p class="text-gray-300 leading-relaxed">
                            Dialogue is the bridge. We foster a culture of constructive interaction aimed at a functional, sustainable utopia.
                        </p>
                    </div>
                </div>
            </div>

            <!-- 7. Structural Reform -->
            <div class="glass-card p-10 rounded-2xl border-l-4 border-white hover:bg-white/5 transition-all duration-500 lg:col-span-3">
                <div class="flex flex-col md:flex-row gap-10 items-center">
                    <div class="text-center md:text-left">
                        <h2 class="text-3xl font-bold text-white mb-4 brand-font">Governmental Evolution</h2>
                        <p class="text-gray-300 leading-relaxed text-lg">
                            Reforming the foundation. Transitioning from legacy control systems to modern, transparent, and biologically-aware governance.
                        </p>
                    </div>
                    <div class="bg-white/10 p-10 rounded-2xl text-white hidden md:block">
                        <i class="fas fa-landmark text-6xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Neuro-Health Impact Simulator Integration -->
        <div class="mt-32 space-y-12" id="simulator-section">
            <div class="text-center mb-12">
                <h2 class="text-4xl md:text-5xl font-black text-white brand-font tracking-tight uppercase">Actuarial Biological Impact</h2>
                <div class="w-24 h-1 bg-[#D4AF37] mx-auto mt-4"></div>
                <p class="text-gray-400 mt-6 max-w-3xl mx-auto">
                    A high-resolution simulation of cumulative substance interaction. Modeled on threshold risk curves, striatal receptor downregulation, and cognitive resource attrition over a 40-year horizon.
                </p>
            </div>

            <!-- Simulator Controls -->
            <div class="glass-card p-8 rounded-2xl border-b border-[#D4AF37]/30">
                <div class="flex flex-col gap-8">
                    <!-- Tabs -->
                    <div class="flex flex-wrap bg-white/5 p-1 rounded-xl w-fit gap-1 border border-white/10" id="substanceTabs">
                        <button onclick="switchTab('alcohol')" id="btn-alcohol" class="tab-btn px-4 py-2 rounded-lg text-[10px] font-bold transition-all tab-active uppercase tracking-widest">Alcohol</button>
                        <button onclick="switchTab('tobacco')" id="btn-tobacco" class="tab-btn px-4 py-2 rounded-lg text-[10px] font-bold transition-all text-gray-500 hover:text-white uppercase tracking-widest">Tobacco</button>
                        <button onclick="switchTab('vape')" id="btn-vape" class="tab-btn px-4 py-2 rounded-lg text-[10px] font-bold transition-all text-gray-500 hover:text-white uppercase tracking-widest">Nic Vape</button>
                        <button onclick="switchTab('sugar')" id="btn-sugar" class="tab-btn px-4 py-2 rounded-lg text-[10px] font-bold transition-all text-gray-500 hover:text-white uppercase tracking-widest">Added Sugar</button>
                        <button onclick="switchTab('mj')" id="btn-mj" class="tab-btn px-4 py-2 rounded-lg text-[10px] font-bold transition-all text-gray-500 hover:text-white uppercase tracking-widest">Marijuana</button>
                        <button onclick="switchTab('mjvape')" id="btn-mjvape" class="tab-btn px-4 py-2 rounded-lg text-[10px] font-bold transition-all text-gray-500 hover:text-white uppercase tracking-widest">THC Vape</button>
                        <button onclick="switchTab('shs')" id="btn-shs" class="tab-btn px-4 py-2 rounded-lg text-[10px] font-bold transition-all text-gray-500 hover:text-white uppercase tracking-widest">SHS</button>
                    </div>

                    <!-- Active Slider -->
                    <div class="bg-black/40 p-8 rounded-xl border border-white/5 shadow-inner" id="sliderContainer">
                        <div id="panel-alcohol" class="tab-panel space-y-4">
                            <div class="flex justify-between items-end">
                                <span class="text-xs font-bold text-[#D4AF37] uppercase tracking-tighter brand-font">Alcohol Consumption (Drinks / Week)</span>
                                <span class="text-3xl font-black text-white" id="val-alcohol">1</span>
                            </div>
                            <input type="range" min="0" max="21" value="1" step="1" oninput="updateInput('alcohol', this.value)" class="custom-range-gold w-full appearance-none bg-white/10 h-2 rounded-full outline-none">
                        </div>
                        <div id="panel-tobacco" class="tab-panel hidden space-y-4">
                            <div class="flex justify-between items-end">
                                <span class="text-xs font-bold text-red-500 uppercase tracking-tighter brand-font">Cigarettes (Units / Week)</span>
                                <span class="text-3xl font-black text-white" id="val-tobacco">0</span>
                            </div>
                            <input type="range" min="0" max="140" value="0" step="1" oninput="updateInput('tobacco', this.value)" class="custom-range-gold w-full appearance-none bg-white/10 h-2 rounded-full outline-none">
                        </div>
                        <div id="panel-vape" class="tab-panel hidden space-y-4">
                            <div class="flex justify-between items-end">
                                <span class="text-xs font-bold text-purple-400 uppercase tracking-tighter brand-font">Nicotine E-Liquid (mL / Week)</span>
                                <span class="text-3xl font-black text-white" id="val-vape">0</span>
                            </div>
                            <input type="range" min="0" max="20" value="0" step="1" oninput="updateInput('vape', this.value)" class="custom-range-gold w-full appearance-none bg-white/10 h-2 rounded-full outline-none">
                        </div>
                        <div id="panel-sugar" class="tab-panel hidden space-y-4">
                            <div class="flex justify-between items-end">
                                <span class="text-xs font-bold text-orange-400 uppercase tracking-tighter brand-font">Added Sugar (Grams / Day)</span>
                                <span class="text-3xl font-black text-white" id="val-sugar">25</span>
                            </div>
                            <input type="range" min="0" max="250" value="25" step="5" oninput="updateInput('sugar', this.value)" class="custom-range-gold w-full appearance-none bg-white/10 h-2 rounded-full outline-none">
                        </div>
                        <div id="panel-mj" class="tab-panel hidden space-y-4">
                            <div class="flex justify-between items-end">
                                <span class="text-xs font-bold text-emerald-400 uppercase tracking-tighter brand-font">Marijuana Flower (Grams / Week)</span>
                                <span class="text-3xl font-black text-white" id="val-mj">0</span>
                            </div>
                            <input type="range" min="0" max="14" value="0" step="0.5" oninput="updateInput('mj', this.value)" class="custom-range-gold w-full appearance-none bg-white/10 h-2 rounded-full outline-none">
                        </div>
                        <div id="panel-mjvape" class="tab-panel hidden space-y-4">
                            <div class="flex justify-between items-end">
                                <span class="text-xs font-bold text-teal-400 uppercase tracking-tighter brand-font">THC Distillate (Grams / Week)</span>
                                <span class="text-3xl font-black text-white" id="val-mjvape">0</span>
                            </div>
                            <input type="range" min="0" max="5" value="0" step="0.1" oninput="updateInput('mjvape', this.value)" class="custom-range-gold w-full appearance-none bg-white/10 h-2 rounded-full outline-none">
                        </div>
                        <div id="panel-shs" class="tab-panel hidden space-y-4">
                            <div class="flex justify-between items-end">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-tighter brand-font">SHS Exposure (Hours / Week)</span>
                                <span class="text-3xl font-black text-white" id="val-shs">0</span>
                            </div>
                            <input type="range" min="0" max="60" value="0" step="1" oninput="updateInput('shs', this.value)" class="custom-range-gold w-full appearance-none bg-white/10 h-2 rounded-full outline-none">
                        </div>
                    </div>

                    <!-- Visibility Toggles -->
                    <div class="flex flex-wrap gap-2 justify-center" id="toggleContainer"></div>
                </div>
            </div>

            <!-- Charts and Metrics -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Main Chart -->
                <div class="lg:col-span-8 glass-card p-8 rounded-2xl border border-white/10">
                    <h2 class="text-xl font-bold mb-6 text-white brand-font tracking-wide">Cognitive & Physical Capacity Retention (%)</h2>
                    <div class="h-[400px]">
                        <canvas id="capacityChart"></canvas>
                    </div>
                </div>

                <!-- Metrics Panel -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="flex justify-between items-center px-2">
                        <h2 class="text-lg font-bold brand-font text-[#D4AF37] uppercase tracking-widest">Snapshot</h2>
                        <div class="flex bg-white/5 p-1 rounded-lg gap-1 border border-white/10" id="timeframeToggles">
                            <button onclick="setTimeframe(1)" class="time-btn px-2 py-1 text-[10px] font-bold rounded-md uppercase">1y</button>
                            <button onclick="setTimeframe(5)" class="time-btn px-2 py-1 text-[10px] font-bold rounded-md uppercase">5y</button>
                            <button onclick="setTimeframe(10)" class="time-btn px-2 py-1 text-[10px] font-bold rounded-md uppercase">10y</button>
                            <button onclick="setTimeframe(20)" class="time-btn px-2 py-1 text-[10px] font-bold rounded-md uppercase">20y</button>
                            <button onclick="setTimeframe(40)" class="time-btn time-btn-active px-2 py-1 text-[10px] font-bold rounded-md uppercase">40y</button>
                        </div>
                    </div>
                    
                    <div id="metricCards" class="grid grid-cols-1 gap-3 max-h-[850px] overflow-y-auto pr-1"></div>
                    
                    <div class="p-6 bg-[#D4AF37]/5 rounded-xl border border-[#D4AF37]/20">
                        <h4 class="text-xs font-bold text-[#D4AF37] mb-2 flex items-center gap-2 uppercase tracking-widest">Economic Variance</h4>
                        <p id="incomeDeltaText" class="text-sm text-gray-300 leading-tight">Projected annual earning deficit: $0.</p>
                    </div>
                </div>

                <!-- Vitality / Long-term Chart -->
                <div class="lg:col-span-12 glass-card p-8 rounded-2xl border border-white/10">
                    <h2 class="text-xl font-bold mb-6 text-white brand-font tracking-wide text-center">Longevity, Mortality & Fiscal Trajectory</h2>
                    <div class="h-[450px]">
                        <canvas id="vitalityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Call to Action -->
        <div class="mt-32 text-center pb-12">
            <h3 class="text-3xl text-white font-bold mb-8 brand-font">Align with the Movement</h3>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <a href="/contact" class="btn-gold px-10 py-5 rounded text-lg shadow-[0_0_25px_rgba(212,175,55,0.4)]">
                    Join the Mission
                </a>
                <a href="/merch" class="btn-outline px-10 py-5 rounded text-lg">
                    Represent the Platform
                </a>
            </div>
        </div>

    </div>
</section>

<!-- Additional Styles for Simulator Integration -->
<style>
    .tab-active {
        background: var(--gold-primary);
        color: black !important;
        box-shadow: 0 0 15px rgba(212,175,55,0.4);
    }
    .time-btn {
        color: #94a3b8;
        transition: all 0.3s ease;
    }
    .time-btn:hover {
        color: white;
    }
    .time-btn-active {
        background: var(--gold-primary);
        color: black !important;
    }

    /* Custom Slider Styling */
    .custom-range-gold::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        background: var(--gold-primary);
        border: 2px solid white;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(212,175,55,0.8);
    }
    .custom-range-gold::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: var(--gold-primary);
        border: 2px solid white;
        border-radius: 50%;
        cursor: pointer;
    }

    /* Scrollbar for metrics */
    #metricCards::-webkit-scrollbar { width: 4px; }
    #metricCards::-webkit-scrollbar-thumb { background: rgba(212,175,55,0.3); border-radius: 10px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const state = {
        alcohol: 1, tobacco: 0, vape: 0, sugar: 25, mj: 0, mjvape: 0, shs: 0,
        visibleMetrics: ['income', 'memory', 'happiness', 'lifespan', 'mortality'],
        selectedYear: 40
    };

    const timelines = [0, 0.5, 1, 2, 3, 5, 10, 15, 20, 25, 30, 35, 40];
    const BASE_LIFE = 80;
    const BASE_INCOME = 92000;

    const metrics = [
        { id: 'focus', name: 'Focus', color: '#D4AF37', type: 'perf', floor: 50, alc: 0.002, tob: 0.003, v: 0.003, sug: 0.002, mj: 0.005, mjv: 0.006, shs: 0.001 },
        { id: 'energy', name: 'Energy', color: '#F4C430', type: 'perf', floor: 40, alc: 0.005, tob: 0.007, v: 0.006, sug: 0.010, mj: 0.002, mjv: 0.002, shs: 0.003 },
        { id: 'thinking', name: 'Logic/PFC', color: '#8b5cf6', type: 'perf', floor: 50, alc: 0.004, tob: 0.005, v: 0.003, sug: 0.001, mj: 0.003, mjv: 0.004, shs: 0.001 },
        { id: 'memory', name: 'Memory', color: '#ef4444', type: 'perf', floor: 40, alc: 0.008, tob: 0.002, v: 0.002, sug: 0.001, mj: 0.010, mjv: 0.012, shs: 0.001 },
        { id: 'happiness', name: 'Happiness', color: '#22c55e', type: 'perf', floor: 65, alc: 0.006, tob: 0.004, v: 0.005, sug: 0.004, mj: 0.001, mjv: 0.002, shs: 0.001 },
        { id: 'sexDrive', name: 'Sex Drive', color: '#ec4899', type: 'perf', floor: 20, alc: 0.003, tob: 0.010, v: 0.009, sug: 0.008, mj: 0.002, mjv: 0.002, shs: 0.005 },
        { id: 'income', name: 'Income ($/y)', color: '#059669', type: 'money', floor: 40 },
        { id: 'mortality', name: 'Mortality HR', color: '#f43f5e', type: 'risk' },
        { id: 'lifespan', name: 'Lifespan', color: '#20B2AA', type: 'age' }
    ];

    let capacityChart, vitalityChart;

    function calculateImpact() {
        return timelines.map(year => {
            const data = { year: year + 'y', rawYear: year };
            let lifespanLoss = 0;
            if (state.alcohol > 7) lifespanLoss += 0.04 * Math.pow(state.alcohol - 7, 1.4);
            const cigsDay = state.tobacco / 7;
            lifespanLoss += cigsDay * 0.45;
            lifespanLoss += (state.vape / 7) * 0.15;
            lifespanLoss += (state.shs / 10) * 0.2;
            if (state.sugar > 36) lifespanLoss += 0.02 * Math.pow((state.sugar - 36) / 10, 1.2);

            const alcHR = state.alcohol <= 7 ? 1.0 : 1.0 + (state.alcohol - 7) * 0.035;
            const tobHR = state.tobacco === 0 ? 1.0 : 1.45 + (cigsDay * 0.04);
            const sugHR = state.sugar <= 36 ? 1.0 : 1.0 + ((state.sugar - 36) / 50) * 0.18;
            const totalHR = alcHR * tobHR * sugHR;

            metrics.forEach(m => {
                if (year === 0) {
                    if (m.type === 'perf') data[m.id] = 100.0;
                    else if (m.id === 'income') data[m.id] = BASE_INCOME;
                    else if (m.type === 'risk') data[m.id] = 0;
                    else data[m.id] = BASE_LIFE;
                } else {
                    if (m.id === 'mortality') {
                        data[m.id] = Number(((totalHR - 1) * 100).toFixed(1));
                    } else if (m.id === 'lifespan') {
                        const distributedLoss = (lifespanLoss * (year / 10));
                        data[m.id] = Number(Math.max(60, BASE_LIFE - distributedLoss).toFixed(1));
                    } else if (m.id === 'income') {
                        const perfWeights = { focus: 0.3, thinking: 0.4, energy: 0.3 };
                        let weightedRem = 0;
                        const incomeFloor = m.floor / 100;
                        Object.keys(perfWeights).forEach(pId => {
                            const pMetric = metrics.find(x => x.id === pId);
                            const rate = [
                                pMetric.alc * state.alcohol * (state.alcohol > 7 ? 1.3 : 1.0),
                                pMetric.tob * state.tobacco * (state.tobacco > 5 ? 1.25 : 1.0),
                                pMetric.v * state.vape * (state.vape > 4 ? 1.3 : 1.0),
                                pMetric.sug * (Math.max(0, state.sugar - 25) / 10),
                                pMetric.mj * state.mj * (state.mj > 3 ? 1.1 : 1.0),
                                pMetric.mjv * state.mjvape,
                                pMetric.shs * (state.shs / 5)
                            ].reduce((a,b)=>a+(b||0), 0);
                            const pFloor = pMetric.floor / 100;
                            const rem = pFloor + (1 - pFloor) * Math.pow(1 - rate, year);
                            weightedRem += rem * perfWeights[pId];
                        });
                        const finalRem = incomeFloor + (1 - incomeFloor) * weightedRem;
                        data[m.id] = Math.round(finalRem * BASE_INCOME);
                    } else {
                        const rates = [
                            m.alc * state.alcohol * (state.alcohol > 7 ? 1.3 : 1.0),
                            m.tob * state.tobacco * (state.tobacco > 5 ? 1.25 : 1.0),
                            m.v * state.vape * (state.vape > 4 ? 1.3 : 1.0),
                            m.sug * (Math.max(0, state.sugar - 25) / 10),
                            m.mj * state.mj * (state.mj > 3 ? 1.1 : 1.0), 
                            m.mjv * state.mjvape, 
                            m.shs * (state.shs / 5)
                        ];
                        let totalRate = rates.reduce((a, b) => a + (b || 0), 0);
                        const activeCount = [state.alcohol, state.tobacco, state.vape, state.sugar > 40, state.mj].filter(v => v > 0).length;
                        if (activeCount >= 2) totalRate *= 1.1;
                        const floorVal = (m.floor || 0) / 100;
                        const decay = Math.pow(1 - totalRate, year);
                        const remVal = floorVal + (1 - floorVal) * decay;
                        data[m.id] = Number((remVal * 100).toFixed(1));
                    }
                }
            });
            return data;
        });
    }

    function init() {
        const toggleContainer = document.getElementById('toggleContainer');
        metrics.forEach(m => {
            const btn = document.createElement('button');
            btn.id = `toggle-${m.id}`;
            btn.className = `px-3 py-1 rounded-full text-[9px] font-bold border border-white/10 transition-all uppercase tracking-widest ${state.visibleMetrics.includes(m.id) ? 'bg-[#D4AF37] text-black' : 'bg-white/5 text-gray-500'}`;
            btn.textContent = m.name;
            btn.onclick = () => {
                if (state.visibleMetrics.includes(m.id)) state.visibleMetrics = state.visibleMetrics.filter(id => id !== m.id);
                else state.visibleMetrics.push(m.id);
                updateUI();
            };
            toggleContainer.appendChild(btn);
        });
        updateUI();
    }

    function setTimeframe(y) {
        state.selectedYear = y;
        document.querySelectorAll('.time-btn').forEach(b => {
            b.classList.remove('time-btn-active');
            if (b.textContent === y + 'Y') b.classList.add('time-btn-active');
        });
        updateUI();
    }

    function updateUI() {
        const data = calculateImpact();
        const cardYearData = data.find(d => d.rawYear === state.selectedYear) || data[data.length - 1];

        metrics.forEach(m => {
            const btn = document.getElementById(`toggle-${m.id}`);
            if (btn) btn.className = `px-3 py-1 rounded-full text-[9px] font-bold border border-white/10 transition-all uppercase tracking-widest ${state.visibleMetrics.includes(m.id) ? 'bg-[#D4AF37] text-black' : 'bg-white/5 text-gray-500'}`;
        });

        const cardContainer = document.getElementById('metricCards');
        cardContainer.innerHTML = '';
        metrics.forEach(m => {
            const val = cardYearData[m.id];
            const isActive = state.visibleMetrics.includes(m.id);
            const div = document.createElement('div');
            div.className = `p-4 rounded-xl border flex items-center gap-4 transition-all ${isActive ? 'glass-card border-white/20' : 'bg-white/5 opacity-20 grayscale'}`;
            
            let displayVal = m.type === 'money' ? `$${val.toLocaleString()}` : m.type === 'age' ? `${val}y` : `${m.type === 'risk' ? '+' : ''}${val}%`;
            let barWidth = m.type === 'risk' ? (Math.min(100, val)) : (m.type === 'money' ? (val/BASE_INCOME*100) : (m.type === 'age' ? (val/BASE_LIFE*100) : val));

            div.innerHTML = `
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-gray-400 text-[9px] uppercase tracking-widest brand-font">${m.name}</span>
                        <span class="text-sm font-black text-white">${displayVal}</span>
                    </div>
                    <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full transition-all duration-700" style="width: ${barWidth}%; background-color: ${m.color}"></div>
                    </div>
                </div>
            `;
            cardContainer.appendChild(div);
        });

        document.getElementById('incomeDeltaText').textContent = `Projected annual earning deficit (${state.selectedYear}y): $${(BASE_INCOME - cardYearData.income).toLocaleString()}.`;
        renderCharts(data);
    }

    function renderCharts(data) {
        const labels = data.map(d => d.year);
        const chartColor = 'rgba(255, 255, 255, 0.1)';
        const textMainColor = '#94a3b8';

        const commonOptions = {
            responsive: true, maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: { 
                legend: { display: true, position: 'bottom', labels: { boxWidth: 10, color: '#fff', font: { size: 9, family: 'Raleway' } } },
                tooltip: { backgroundColor: '#111', titleFont: { family: 'Cinzel' }, bodyFont: { family: 'Raleway' }, borderColor: '#D4AF37', borderWidth: 1 } 
            },
            scales: {
                x: { grid: { color: chartColor }, ticks: { color: textMainColor, font: { size: 9 } } },
                y: { grid: { color: chartColor }, ticks: { color: textMainColor, font: { size: 9 } } }
            }
        };

        // Capacity Chart
        const capacityDatasets = metrics.filter(m => m.type === 'perf' && state.visibleMetrics.includes(m.id)).map(m => ({
            label: m.name, data: data.map(d => d[m.id]), borderColor: m.color, borderWidth: 2, tension: 0.4, pointRadius: 0
        }));

        if (capacityChart) capacityChart.destroy();
        capacityChart = new Chart(document.getElementById('capacityChart'), {
            type: 'line', data: { labels, datasets: capacityDatasets },
            options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, min: 0, max: 100 } } }
        });

        // Vitality Chart
        const vitalityDatasets = [
            { label: 'Mortality HR Increase %', data: data.map(d => d.mortality), borderColor: '#f43f5e', yAxisID: 'y1', pointRadius: 0, hidden: !state.visibleMetrics.includes('mortality') },
            { label: 'Projected Lifespan (y)', data: data.map(d => d.lifespan), borderColor: '#20B2AA', yAxisID: 'y2', pointRadius: 0, hidden: !state.visibleMetrics.includes('lifespan') },
            { label: 'Annual Income ($)', data: data.map(d => d.income), borderColor: '#D4AF37', yAxisID: 'y3', borderDash: [5,5], pointRadius: 0, hidden: !state.visibleMetrics.includes('income') }
        ];

        if (vitalityChart) vitalityChart.destroy();
        vitalityChart = new Chart(document.getElementById('vitalityChart'), {
            type: 'line', data: { labels, datasets: vitalityDatasets },
            options: { ...commonOptions,
                scales: {
                    x: commonOptions.scales.x,
                    y1: { type: 'linear', position: 'left', min: 0, grid: { color: chartColor }, ticks: { color: '#f43f5e' } },
                    y2: { type: 'linear', position: 'right', min: 40, max: 90, grid: { display: false }, ticks: { color: '#20B2AA' } },
                    y3: { type: 'linear', position: 'right', min: 0, max: BASE_INCOME, grid: { display: false }, ticks: { color: '#D4AF37' } }
                }
            }
        });
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
        document.getElementById('panel-' + tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active', 'text-gray-500'));
        document.getElementById('btn-' + tabId).classList.add('tab-active');
    }

    function updateInput(key, val) {
        state[key] = parseFloat(val);
        const unit = key === 'sugar' ? 'g' : key === 'shs' ? 'h' : (key === 'vape' || key === 'mjvape' ? 'mL/g' : '');
        document.getElementById('val-' + key).textContent = val + unit;
        updateUI();
    }

    window.addEventListener('load', init);
</script>

<%- include('partials/footer') %>