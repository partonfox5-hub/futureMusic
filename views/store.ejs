const Cart = {
    get: () => JSON.parse(localStorage.getItem('captain_cart')) || [],
    set: (cart) => localStorage.setItem('captain_cart', JSON.stringify(cart)),
    
    add: (item) => {
        const cart = Cart.get();
        cart.push(item);
        Cart.set(cart);
        Cart.updateBadge();
        
        // Visual Feedback
        alert(`${item.name} added to manifest.`);
    },

    remove: (index) => {
        const cart = Cart.get();
        cart.splice(index, 1);
        Cart.set(cart);
        if (window.renderCartPage) window.renderCartPage(); 
        Cart.updateBadge();
    },

    clear: () => {
        localStorage.removeItem('captain_cart');
        Cart.updateBadge();
    },

    updateBadge: () => {
        const count = Cart.get().length;
        const badge = document.getElementById('cart-count');
        if(badge) {
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);
        }
    }
};

document.addEventListener('DOMContentLoaded', () => {
    Cart.updateBadge();

    // Global listener for dynamic buttons
    document.body.addEventListener('click', (e) => {
        // Find closest button with class 'add-to-cart-btn'
        const btn = e.target.closest('.add-to-cart-btn');
        
        if (btn) {
            e.preventDefault(); // Prevent navigation if it's inside an <a> tag
            
            const item = {
                id: btn.dataset.id || btn.dataset.songId, // Support both ID types
                name: btn.dataset.name,
                price: parseFloat(btn.dataset.price),
                type: btn.dataset.type
            };

            // Basic validation
            if(!item.id || !item.name) {
                console.error("Missing item data:", item);
                return;
            }
            
            Cart.add(item);
        }
    });
});