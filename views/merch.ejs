<%- include('partials/header') %>

<section class="max-w-7xl mx-auto py-12 px-4">
    
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-6">
        <div>
            <h1 class="text-4xl text-[#D4AF37] brand-font mb-2">Merch Protocol</h1>
            <p class="text-gray-400 text-sm">Official equipment and artifacts.</p>
        </div>

        <!-- Filter & Sort Form -->
        <form action="/merch" method="GET" class="glass-card p-4 rounded-lg flex flex-wrap gap-4 items-center border border-gray-700">
            <!-- Filter Type -->
            <div class="flex flex-col">
                <label class="text-[10px] uppercase text-[#D4AF37] tracking-widest font-bold mb-1">Type</label>
                <select name="type" onchange="this.form.submit()" class="bg-black/50 text-white text-sm border border-gray-600 rounded px-3 py-2 outline-none focus:border-[#D4AF37]">
                    <option value="all" <%= (!query.type || query.type === 'all') ? 'selected' : '' %>>All Classes</option>
                    <option value="T-Shirts" <%= query.type === 'T-Shirts' ? 'selected' : '' %>>T-Shirts</option>
                    <option value="Hoodies" <%= query.type === 'Hoodies' ? 'selected' : '' %>>Hoodies</option>
                    <option value="Accessories" <%= query.type === 'Accessories' ? 'selected' : '' %>>Accessories</option>
                    <option value="Digital" <%= query.type === 'Digital' ? 'selected' : '' %>>Digital</option>
                </select>
            </div>

            <!-- Sort -->
            <div class="flex flex-col">
                <label class="text-[10px] uppercase text-[#D4AF37] tracking-widest font-bold mb-1">Sort</label>
                <select name="sort" onchange="this.form.submit()" class="bg-black/50 text-white text-sm border border-gray-600 rounded px-3 py-2 outline-none focus:border-[#D4AF37]">
                    <option value="newest" <%= (!query.sort || query.sort === 'newest') ? 'selected' : '' %>>Newest Arrival</option>
                    <option value="price_asc" <%= query.sort === 'price_asc' ? 'selected' : '' %>>Price: Low to High</option>
                    <option value="price_desc" <%= query.sort === 'price_desc' ? 'selected' : '' %>>Price: High to Low</option>
                </select>
            </div>
        </form>
    </div>

    <!-- Product Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        <% if (products.length > 0) { %>
            <% products.forEach(function(p) { %>
                <div class="group relative glass-card border border-gray-800 hover:border-[#D4AF37]/50 transition-all duration-300 rounded-xl overflow-hidden flex flex-col">
                    
                    <!-- Image -->
                    <a href="/product/<%= p.sku %>" class="block relative aspect-[4/5] overflow-hidden bg-black/50">
                        <img 
                            src="<%= p.image_url %>" 
                            onerror="this.src='https://placehold.co/600x600/111/D4AF37?text=NO+IMAGE'" 
                            alt="<%= p.name %>" 
                            class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-700"
                        >
                        <% if (p.stock_quantity <= 0) { %>
                            <div class="absolute inset-0 bg-black/70 flex items-center justify-center">
                                <span class="text-white font-bold tracking-widest border border-white px-4 py-2">SOLD OUT</span>
                            </div>
                        <% } %>
                    </a>

                    <!-- Details -->
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="mb-4 flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-lg font-bold text-white leading-tight">
                                    <a href="/product/<%= p.sku %>" class="hover:text-[#D4AF37] transition-colors"><%= p.name %></a>
                                </h3>
                                <span class="text-[#D4AF37] font-mono font-bold whitespace-nowrap ml-4">$<%= p.price %></span>
                            </div>
                            <p class="text-gray-500 text-xs uppercase tracking-wider"><%= p.type %></p>
                        </div>

                        <!-- Quick Add -->
                        <button 
                            class="add-to-cart-btn w-full py-3 bg-[#D4AF37]/10 hover:bg-[#D4AF37] border border-[#D4AF37] text-[#D4AF37] hover:text-black font-bold uppercase tracking-widest transition-all duration-300 flex items-center justify-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed"
                            data-id="<%= p.sku %>"
                            data-name="<%= p.name %>"
                            data-price="<%= p.price %>"
                            data-image="<%= p.image_url %>"
                            <%= p.stock_quantity <= 0 ? 'disabled' : '' %>
                        >
                            <span><%= p.stock_quantity <= 0 ? 'Unavailable' : 'Add to Manifest' %></span>
                            <% if (p.stock_quantity > 0) { %>
                                <i class="fas fa-plus transform group-hover:rotate-90 transition-transform"></i>
                            <% } %>
                        </button>
                    </div>

                </div>
            <% }); %>
        <% } else { %>
            <div class="col-span-full py-20 text-center">
                <i class="fas fa-box-open text-6xl text-gray-700 mb-4"></i>
                <p class="text-gray-400 text-lg">No artifacts found matching your criteria.</p>
                <a href="/merch" class="inline-block mt-4 text-[#D4AF37] hover:underline">Clear Filters</a>
            </div>
        <% } %>
    </div>

</section>

<%- include('partials/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Handle Quick Add Buttons on this page
        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                
                if (btn.disabled) return;

                const sku = btn.dataset.id;
                // Quick add always defaults size to null (perfect for Digital items)
                // For sized items (Shirts), the backend or user should ideally go to product page, 
                // but this "Quick Add" implies a default or no-size add.
                const size = null; 

                // Visual Feedback
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                try {
                    // Get Session ID similar to store.js / product.ejs logic
                    let cookieSid = document.cookie.match(/connect.sid=([^;]+)/)?.[1];
                    if (cookieSid) {
                        cookieSid = decodeURIComponent(cookieSid).split('.')[0].slice(2);
                    }
                    const storeSessionId = localStorage.getItem('sessionId') || cookieSid || '';

                    const res = await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sku, size, sessionId: storeSessionId })
                    });
                    
                    // Check if response is JSON
                    const contentType = res.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        const textText = await res.text();
                        console.error("Server returned non-JSON:", textText);
                        throw new Error("Server Error: Check console for details");
                    }

                    const data = await res.json();
                    
                        if (data.success) {
                        // Success Feedback
                        btn.innerHTML = 'ADDED';
                        btn.classList.add('bg-white', 'text-black');
                        
                        // Update Cart Count
                        const badge = document.getElementById('cart-count');
                        if (badge) {
                            let currentCount = parseInt(badge.innerText) || 0;
                            badge.innerText = currentCount + 1;
                            badge.classList.remove('hidden');
                        }

                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('bg-white', 'text-black');
                            btn.disabled = false;
                        }, 2000);
                    } else {
                        // LOG THE SERVER ERROR TO CONSOLE
                        console.error("SERVER ERROR DETAILS:", data);
                        alert('Error: ' + (data.error || 'Unknown error'));
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (err) {
                    console.error('Add to cart failed:', err);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });
    });
</script>