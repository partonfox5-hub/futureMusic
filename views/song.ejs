<%- include('partials/header') %>

<% 
    // Helper to determine the best ID and Image to use
    const hasVideo = song.youtube_info && song.youtube_info.video_id;
    const songId = hasVideo ? song.youtube_info.video_id : song.spotify_id;
    const thumbnail = hasVideo 
        ? `https://img.youtube.com/vi/${song.youtube_info.video_id}/maxresdefault.jpg` 
        : '/images/default-album-art.jpg'; // Fallback image path
%>

<section class="min-h-screen bg-black text-white pt-32 pb-20 px-4 relative overflow-hidden">
    
    <!-- Background Blur Effect -->
    <div class="absolute inset-0 z-0 opacity-20 pointer-events-none">
        <div class="absolute inset-0 bg-cover bg-center blur-[100px] scale-110" style="background-image: url('<%= thumbnail %>');"></div>
    </div>

    <div class="max-w-6xl mx-auto relative z-10 grid grid-cols-1 lg:grid-cols-3 gap-12">
        
        <!-- Left Column: Visual Media -->
        <div class="lg:col-span-2 space-y-8">
            <div class="w-full aspect-video bg-black rounded-xl overflow-hidden shadow-[0_0_50px_rgba(212,175,55,0.2)] border border-gray-800">
                <% if (hasVideo) { %>
                    <iframe 
                        class="w-full h-full" 
                        src="https://www.youtube.com/embed/<%= songId %>?autoplay=1&mute=0" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        allowfullscreen>
                    </iframe>
                <% } else if (song.spotify_link) { %>
                    <div class="w-full h-full flex flex-col items-center justify-center p-8 bg-gradient-to-br from-gray-900 to-black">
                        <img src="/images/default-album-art.jpg" class="w-48 h-48 rounded shadow-lg mb-6 opacity-50">
                        <a href="<%= song.spotify_link %>" target="_blank" class="text-[#1DB954] hover:text-white transition-colors text-2xl font-bold flex items-center gap-3">
                            <i class="fab fa-spotify text-4xl"></i> Listen on Spotify
                        </a>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Right Column: Info & Actions -->
        <div class="lg:col-span-1">
            <div class="glass-card p-8 rounded-xl border border-gray-800 sticky top-32">
                <h1 class="text-3xl md:text-4xl font-black text-[#D4AF37] mb-2 leading-tight brand-font"><%= song.name %></h1>
                
                <% if (song.album) { %>
                    <h2 class="text-xl text-[#20B2AA] uppercase tracking-widest mb-6 font-light"><%= song.album %></h2>
                <% } %>

                <div class="prose prose-invert max-w-none text-gray-400 mb-8 text-sm leading-relaxed">
                    <% if (song.youtube_info && song.youtube_info.description) { %>
                        <!-- Converting newlines to breaks for display -->
                        <%- song.youtube_info.description.replace(/\n/g, '<br>') %>
                    <% } else { %>
                        <p class="italic opacity-50">No transmission data available.</p>
                    <% } %>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-4">
                    <% if (song.spotify_link) { %>
                        <a href="<%= song.spotify_link %>" target="_blank" class="flex items-center justify-center w-full py-4 bg-[#1DB954] hover:bg-[#1ed760] text-black font-bold rounded transition-all duration-300 shadow-lg group">
                            <i class="fab fa-spotify text-xl mr-3 group-hover:scale-110 transition-transform"></i> 
                            Stream on Spotify
                        </a>
                    <% } %>

                    <div class="grid grid-cols-1 gap-4 pt-4 border-t border-gray-800">
                        <!-- Add to Downloads Button -->
                        <!-- ADDED data attributes for cart logic -->
                        <button class="w-full bg-white hover:bg-[#D4AF37] text-black font-bold py-4 rounded transition-all duration-300 shadow-[0_0_20px_rgba(255,255,255,0.2)] hover:shadow-[0_0_30px_rgba(212,175,55,0.4)] flex items-center justify-center gap-2 group add-to-cart-btn"
                            data-id="<%= songId %>" 
                            data-name="<%= song.name %>" 
                            data-price="0.99" 
                            data-type="digital">
                            <i class="fas fa-cart-plus group-hover:animate-bounce"></i> Add to Downloads ($0.99)
                        </button>
                    </div>

                    <!-- Additional Info -->
                    <div class="mt-8 pt-6 border-t border-gray-700/50 text-sm text-gray-500 space-y-2">
                        <div class="flex justify-between">
                            <span>Format</span>
                            <span class="text-gray-300">Digital / Stream</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Released</span>
                            <!-- Uses published_at if available, otherwise just Year -->
                            <span class="text-gray-300"><%= (song.youtube_info && song.youtube_info.published_at) ? new Date(song.youtube_info.published_at).toLocaleDateString() : '2025' %></span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <a href="/music" class="text-gray-400 hover:text-[#D4AF37] transition-colors text-sm uppercase tracking-widest flex items-center justify-center gap-2">
                        <i class="fas fa-arrow-left"></i> Return to Discography
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Include Store Logic for Cart functionality -->
<script src="/js/store.js"></script>

<%- include('partials/footer') %>