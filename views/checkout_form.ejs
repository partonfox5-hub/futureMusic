<%- include('partials/header') %>

<section class="max-w-2xl mx-auto py-12 px-4 min-h-[70vh]">
<h1 class="text-4xl text-gold brand-font mb-8 text-center">Secure Checkout</h1>

<div class="glass-card p-8 rounded-xl border border-gray-700">
    <p class="text-gray-400 mb-6 text-center text-sm">Please confirm your shipping details to establish a secure link for this transaction.</p>

    <form id="details-form" class="space-y-6">
        <!-- Personal Info -->
        <div>
            <label for="fullName" class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Full Name</label>
            <input type="text" id="fullName" required value="<%= user.full_name || '' %>"
                class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
        </div>
        
        <div>
            <label for="email" class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Email Address</label>
            <input type="email" id="email" required value="<%= user.email || '' %>"
                class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
        </div>

        <div>
            <label for="phone" class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Phone Number</label>
            <input type="tel" id="phone" required value="<%= user.phone || '' %>"
                class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
        </div>

        <!-- Shipping Info -->
        <div class="border-t border-gray-700 pt-6 mt-6">
            <h3 class="text-xl text-gold brand-font mb-4">Shipping Destination</h3>
        </div>

        <div>
            <label for="address" class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Street Address</label>
            <input type="text" id="address" required value="<%= user.shipping_address || '' %>"
                class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="city" class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">City</label>
                <input type="text" id="city" required value="<%= user.shipping_city || '' %>"
                    class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
            </div>
            <div>
                <label for="state" class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">State/Province</label>
                <input type="text" id="state" required value="<%= user.shipping_state || '' %>"
                    class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="zip" class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Zip/Postal Code</label>
                <input type="text" id="zip" required value="<%= user.shipping_zip || '' %>"
                    class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
            </div>
            <div>
                <label for="country" class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Country</label>
                <input type="text" id="country" required value="<%= user.shipping_country || '' %>"
                    class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
            </div>
        </div>

        <div id="error-msg" role="alert" class="hidden bg-red-900/50 border border-red-500 text-red-200 p-4 rounded text-center text-sm"></div>

        <button type="submit" id="checkout-btn" aria-label="Proceed to Stripe payment" class="w-full btn-gold py-4 text-xl font-bold mt-8 shadow-[0_0_15px_rgba(212,175,55,0.3)] hover:shadow-[0_0_25px_rgba(212,175,55,0.5)] transition-all">
            PROCEED TO PAYMENT <i class="fas fa-lock ml-2" aria-hidden="true"></i>
        </button>
    </form>
</div>


</section>

<script src="https://js.stripe.com/v3/"></script>

<script>
const stripe = Stripe('<%= stripePublishableKey %>');

const form = document.getElementById(&#39;details-form&#39;);

form.addEventListener(&#39;submit&#39;, async (e) =&gt; {
    e.preventDefault();
    const btn = document.getElementById(&#39;checkout-btn&#39;);
    const originalText = btn.innerText;
    
    // Show loading state
    btn.innerHTML = &#39;&lt;i class=&quot;fas fa-spinner fa-spin&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; PROCESSING...&#39;;
    btn.setAttribute(&#39;aria-label&#39;, &#39;Processing your request, please wait&#39;);
    btn.disabled = true;
    btn.classList.add(&#39;opacity-50&#39;, &#39;cursor-not-allowed&#39;);

    const formData = {
        sessionId: localStorage.getItem(&#39;sessionId&#39;), 
        fullName: document.getElementById(&#39;fullName&#39;).value,
        email: document.getElementById(&#39;email&#39;).value,
        phone: document.getElementById(&#39;phone&#39;).value,
        // Shipping Fields
        address: document.getElementById(&#39;address&#39;).value,
        city: document.getElementById(&#39;city&#39;).value,
        state: document.getElementById(&#39;state&#39;).value,
        zip: document.getElementById(&#39;zip&#39;).value,
        country: document.getElementById(&#39;country&#39;).value
    };

    try {
        const response = await fetch(&#39;/initiate-checkout&#39;, {
            method: &#39;POST&#39;,
            headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
            body: JSON.stringify(formData)
        });

        const session = await response.json();

        if (session.error) {
            throw new Error(session.error);
        }

        // Redirect to Stripe
        const result = await stripe.redirectToCheckout({ sessionId: session.id });
        if (result.error) throw new Error(result.error.message);

    } catch (err) {
        console.error(err);
        const errorMsg = document.getElementById(&#39;error-msg&#39;);
        errorMsg.textContent = &quot;Error: &quot; + err.message;
        errorMsg.classList.remove(&#39;hidden&#39;);
        
        btn.innerText = originalText;
        btn.setAttribute(&#39;aria-label&#39;, &#39;Proceed to Stripe payment&#39;);
        btn.disabled = false;
        btn.classList.remove(&#39;opacity-50&#39;, &#39;cursor-not-allowed&#39;);
    }
});


</script>

<%- include('partials/footer') %>