<%- include('partials/header') %>

<section class="max-w-2xl mx-auto py-12 px-4 min-h-[70vh]">
    <h1 class="text-4xl text-gold brand-font mb-8 text-center">Secure Checkout</h1>
    
    <div class="glass-card p-8 rounded-xl border border-gray-700">
        <p class="text-gray-400 mb-6 text-center text-sm">Please confirm your shipping details to establish a secure link for this transaction.</p>

        <form id="details-form" class="space-y-6">
            <!-- Personal Info -->
            <div>
                <label class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Full Name</label>
                <input type="text" id="fullName" required value="<%= user.full_name || '' %>"
                    class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
            </div>
            
            <div>
                <label class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Email Address</label>
                <input type="email" id="email" required value="<%= user.email || '' %>"
                    class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
            </div>

            <div>
                <label class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Phone Number</label>
                <input type="tel" id="phone" required value="<%= user.phone || '' %>"
                    class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
            </div>

            <!-- Shipping Info -->
            <div class="border-t border-gray-700 pt-6 mt-6">
                <h3 class="text-xl text-gold brand-font mb-4">Shipping Destination</h3>
            </div>

            <div>
                <label class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Street Address</label>
                <input type="text" id="address" required value="<%= user.shipping_address || '' %>"
                    class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">City</label>
                    <input type="text" id="city" required value="<%= user.shipping_city || '' %>"
                        class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
                </div>
                <div>
                    <label class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">State/Province</label>
                    <input type="text" id="state" required value="<%= user.shipping_state || '' %>"
                        class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Zip/Postal Code</label>
                    <input type="text" id="zip" required value="<%= user.shipping_zip || '' %>"
                        class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
                </div>
                <div>
                    <label class="block text-[#D4AF37] mb-2 font-bold text-sm uppercase tracking-wider">Country</label>
                    <input type="text" id="country" required value="<%= user.shipping_country || '' %>"
                        class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-[#D4AF37] outline-none transition-colors">
                </div>
            </div>

            <div id="error-msg" class="hidden bg-red-900/50 border border-red-500 text-red-200 p-4 rounded text-center text-sm"></div>

            <button type="submit" id="checkout-btn" class="w-full btn-gold py-4 text-xl font-bold mt-8 shadow-[0_0_15px_rgba(212,175,55,0.3)] hover:shadow-[0_0_25px_rgba(212,175,55,0.5)] transition-all">
                PROCEED TO PAYMENT <i class="fas fa-lock ml-2"></i>
            </button>
        </form>
    </div>
</section>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('pk_test_51QZwb8LcwQZ0XmK0iOqKq2VjX0y2vX0y2vX0y2vX0y2vX0y2vX0y2vX0y2vX0y2v'); // Your Stripe Key

    const form = document.getElementById('details-form');
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('checkout-btn');
        const originalText = btn.innerText;
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESSING...';
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');

        const formData = {
            sessionId: localStorage.getItem('captain_session_id'), 
            fullName: document.getElementById('fullName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            // Shipping Fields
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            zip: document.getElementById('zip').value,
            country: document.getElementById('country').value
        };

        try {
            const response = await fetch('/initiate-checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const session = await response.json();

            if (session.error) {
                throw new Error(session.error);
            }

            // Redirect to Stripe
            const result = await stripe.redirectToCheckout({ sessionId: session.id });
            if (result.error) throw new Error(result.error.message);

        } catch (err) {
            console.error(err);
            const errorMsg = document.getElementById('error-msg');
            errorMsg.textContent = "Error: " + err.message;
            errorMsg.classList.remove('hidden');
            
            btn.innerText = originalText;
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    });
</script>
<%- include('partials/footer') %>